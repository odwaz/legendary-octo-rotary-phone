stages:
  - build
  - test
  - sonarqube
  - docker

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
cache:
  paths:
    - .m2/repository

build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - "*/target/*.jar"
    expire_in: 1 hour

test:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - mvn test
  artifacts:
    reports:
      junit:
        - "*/target/surefire-reports/TEST-*.xml"

sonarqube:
  stage: sonarqube
  image: maven:3.9-eclipse-temurin-17
  script:
    - mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN -Dsonar.projectKey=wallet-microservices -Dsonar.organization=$SONAR_ORGANIZATION
  only:
    - dev
    - staging
    - main

.docker_build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "staging" ]; then
        apk add --no-cache aws-cli
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
      else
        docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_TOKEN
      fi
  script:
    - cd $SERVICE_DIR
    - |
      if [ "$CI_COMMIT_BRANCH" = "staging" ]; then
        IMAGE="$ECR_REGISTRY/wallet-microservices:$SERVICE_NAME-$CI_COMMIT_SHORT_SHA"
        IMAGE_LATEST="$ECR_REGISTRY/wallet-microservices:$SERVICE_NAME-latest"
      else
        IMAGE="$DOCKER_HUB_USER/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA"
        IMAGE_LATEST="$DOCKER_HUB_USER/$SERVICE_NAME:latest"
      fi
    - docker build -t "$IMAGE" -t "$IMAGE_LATEST" .
    - docker push "$IMAGE"
    - docker push "$IMAGE_LATEST"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "staging"'

docker:api-gateway:
  extends: .docker_build
  variables:
    SERVICE_DIR: api-gateway
    SERVICE_NAME: api-gateway

docker:auth-service:
  extends: .docker_build
  variables:
    SERVICE_DIR: auth-service
    SERVICE_NAME: auth-service

docker:wallet-service:
  extends: .docker_build
  variables:
    SERVICE_DIR: wallet-service
    SERVICE_NAME: wallet-service

docker:transaction-service:
  extends: .docker_build
  variables:
    SERVICE_DIR: transaction-service
    SERVICE_NAME: transaction-service

docker:webhook-service:
  extends: .docker_build
  variables:
    SERVICE_DIR: webhook-service
    SERVICE_NAME: webhook-service

